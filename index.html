<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Mammina Mobile Sound Archive</title>
  <style>
    body { margin:0; background:#071827; color:#cfe9ff; font-family:sans-serif; }
    h1 { text-align:center; padding:20px; }
    #stemPanel { display:flex; justify-content:space-around; padding:10px; background:#0f2a3b; }
    .stemControl { display:flex; flex-direction:column; align-items:center; }
    .stemControl label { margin-bottom:6px; font-size:12px; }
    #stemPanel input[type=range] { writing-mode: bt-lr; -webkit-appearance: slider-vertical; width:20px; height:120px; }

    /* Mobile sound pad */
    #mobilePad {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      display: flex;
      justify-content: space-around;
      background: #0f2a3b;
      padding: 14px;
      z-index: 999;
    }
    .soundBtn {
      flex: 1;
      margin: 0 6px;
      padding: 22px;
      font-size: 20px;
      font-weight: bold;
      background: #2aa1c3;
      color: #071827;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .soundBtn:active {
      background: #88d2e8;
      transform: scale(1.1);
    }
    @media (min-width: 768px) {
      #mobilePad { display: none; }
    }

    #controls { padding:20px; text-align:center; }
    button { margin:6px; padding:10px 20px; background:#1e5a6d; color:white; border:2px solid #88d2e8; border-radius:8px; cursor:pointer; }
  </style>
</head>
<body>
  <h1>Mammina Mobile Sound Archive</h1>

  <!-- Stem Player -->
  <div id="stemPanel">
    <div class="stemControl"><label>Bass</label><input type="range" id="stem1" min="0" max="1" step="0.01" value="0.25"></div>
    <div class="stemControl"><label>Synth</label><input type="range" id="stem2" min="0" max="1" step="0.01" value="0.25"></div>
    <div class="stemControl"><label>Pad</label><input type="range" id="stem3" min="0" max="1" step="0.01" value="0.25"></div>
    <div class="stemControl"><label>Voice</label><input type="range" id="stem4" min="0" max="1" step="0.01" value="0.25"></div>
  </div>

  <!-- Controls -->
  <div id="controls">
    <button id="cameraBtn">Open Camera</button>
    <button id="closeCameraBtn" style="display:none;">Close Camera</button>
    <video id="cameraFeed" autoplay playsinline style="display:none; max-width:100%; border:2px solid #2aa1c3;"></video>
    <br>
    <button id="recordBtn">Record</button>
    <button id="stopRecordBtn">Stop & Download</button>
  </div>

  <!-- Mobile Sound Pad -->
  <div id="mobilePad">
    <button class="soundBtn" data-sound="kick">Kick</button>
    <button class="soundBtn" data-sound="snare">Snare</button>
    <button class="soundBtn" data-sound="hihat">HiHat</button>
  </div>

<script>
const audioCtx=new (window.AudioContext||window.webkitAudioContext)();

// Drum sounds
function playKick(){const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
  osc.type="sine"; osc.frequency.setValueAtTime(150,audioCtx.currentTime);
  osc.frequency.exponentialRampToValueAtTime(50,audioCtx.currentTime+0.5);
  gain.gain.setValueAtTime(0.25,audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+0.5);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime+0.5);}
function playSnare(){const buffer=audioCtx.createBuffer(1,audioCtx.sampleRate*0.2,audioCtx.sampleRate);
  const data=buffer.getChannelData(0); for(let i=0;i<data.length;i++){data[i]=Math.random()*2-1;}
  const noise=audioCtx.createBufferSource(); noise.buffer=buffer;
  const gain=audioCtx.createGain(); gain.gain.setValueAtTime(0.2,audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.2);
  noise.connect(gain).connect(audioCtx.destination);
  noise.start(); noise.stop(audioCtx.currentTime+0.2);}
function playHiHat(){const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
  osc.type="square"; osc.frequency.value=8000;
  gain.gain.setValueAtTime(0.1,audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.05);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime+0.05);}

// Attach to mobile buttons
document.querySelectorAll(".soundBtn").forEach(btn=>{
  btn.addEventListener("touchstart",()=>{
    if(audioCtx.state==="suspended") audioCtx.resume();
    if(btn.dataset.sound==="kick") playKick();
    if(btn.dataset.sound==="snare") playSnare();
    if(btn.dataset.sound==="hihat") playHiHat();
  });
});

// Stem player
const stems=[
  {type:"sine",freq:220,slider:document.getElementById("stem1")},
  {type:"square",freq:330,slider:document.getElementById("stem2")},
  {type:"sawtooth",freq:440,slider:document.getElementById("stem3")},
  {type:"triangle",freq:550,slider:document.getElementById("stem4")}
];
stems.forEach(s=>{
  s.osc=audioCtx.createOscillator(); s.gain=audioCtx.createGain();
  s.osc.type=s.type; s.osc.frequency.value=s.freq;
  s.gain.gain.value=parseFloat(s.slider.value)*0.4;
  s.osc.connect(s.gain).connect(audioCtx.destination);
  s.osc.start();
  s.slider.addEventListener("input",e=>{
    s.gain.gain.value=parseFloat(e.target.value)*0.4;
  });
});

// Camera snapshots + sound brightness mapping
const cameraBtn=document.getElementById("cameraBtn"),
      closeCameraBtn=document.getElementById("closeCameraBtn"),
      cameraFeed=document.getElementById("cameraFeed");
let cameraInterval,cameraStream;
cameraBtn.addEventListener("click",async()=>{
  try{
    cameraStream=await navigator.mediaDevices.getUserMedia({video:true});
    cameraFeed.srcObject=cameraStream; cameraFeed.style.display="block";
    closeCameraBtn.style.display="inline-block";
    if(cameraInterval) clearInterval(cameraInterval);
    cameraInterval=setInterval(()=>{
      if(cameraFeed.videoWidth>0){
        const tempCanvas=document.createElement("canvas");
        tempCanvas.width=cameraFeed.videoWidth; tempCanvas.height=cameraFeed.videoHeight;
        const tctx=tempCanvas.getContext("2d"); tctx.drawImage(cameraFeed,0,0);
        const frame=tctx.getImageData(0,0,tempCanvas.width,tempCanvas.height).data;
        let sum=0; for(let i=0;i<frame.length;i+=4){sum+=frame[i]+frame[i+1]+frame[i+2];}
        const avg=sum/(frame.length/4*3);
        const osc=audioCtx.createOscillator(),gain=audioCtx.createGain();
        osc.type="triangle"; osc.frequency.value=200+avg/5;
        gain.gain.value=0.05; osc.connect(gain).connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime+0.2);
      }
    },3000);
  }catch(err){alert("Camera access failed");}
});
closeCameraBtn.addEventListener("click",()=>{
  if(cameraStream){
    cameraStream.getTracks().forEach(track=>track.stop());
    cameraFeed.srcObject=null; 
    cameraFeed.style.display="none";
    closeCameraBtn.style.display="none"; 
    clearInterval(cameraInterval);
  }
});

// Recording
let recorder,chunks=[];
document.getElementById("recordBtn").addEventListener("click",()=>{
  const dest=audioCtx.createMediaStreamDestination();
  stems.forEach(s=>s.gain.connect(dest));
  recorder=new MediaRecorder(dest.stream);
  recorder.ondataavailable=e=>chunks.push(e.data);
  recorder.onstop=()=>{
    const blob=new Blob(chunks,{type:"audio/webm"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); 
    a.href=url; 
    a.download="mammina_recording.webm"; 
    a.click();
    chunks=[];
  };
  recorder.start();
});
document.getElementById("stopRecordBtn").addEventListener("click",()=>{
  if(recorder && recorder.state!=="inactive"){ recorder.stop(); }
});
</script>
</body>
</html>
