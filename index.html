<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Red Gate Camera</title>
  <style>
    :root {
      --bg:#000; --fg:#fff; --accent:#e0182d; --muted:#9aa0a6;
    }
    * { box-sizing:border-box; }
    html, body { height:100%; }
    body {
      margin:0; background:var(--bg); color:var(--fg);
      font:15px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      height:100vh; overflow:hidden;
    }
    .app {
      width:100vw; height:100vh; display:grid;
      grid-template-rows: 62vh 38vh; /* tuned for iPhone 15 portrait */
    }
    .view {
      position:relative; display:flex; align-items:center; justify-content:center; background:#000;
    }
    video {
      width:100vw; height:100%; object-fit:cover; display:block;
    }
    .overlay {
      position:absolute; inset:0; pointer-events:none;
      background:linear-gradient(to top, rgba(0,0,0,.12), rgba(0,0,0,0) 40%);
    }
    .ui {
      display:grid; grid-template-rows: auto 1fr auto; gap:10px;
      padding:12px 16px;
    }
    .status {
      display:flex; align-items:center; justify-content:space-between;
      font-size:14px; color:var(--muted);
    }
    .gate {
      display:inline-flex; align-items:center; gap:8px; font-size:14px;
    }
    .dot {
      width:10px; height:10px; border-radius:50%;
      background:#b0444e; box-shadow:0 0 0 2px rgba(255,255,255,.08) inset;
    }
    .dot.ok { background:#18c46d; }
    .swatch {
      width:16px; height:16px; border-radius:50%; border:1px solid rgba(255,255,255,.25);
      background:hsl(0deg, 85%, 55%);
    }
    .buttons {
      display:flex; gap:12px; align-items:center; justify-content:center;
    }
    button {
      appearance:none; border:none; border-radius:10px; cursor:pointer;
      padding:12px 18px; font-weight:600;
    }
    #shoot {
      background:var(--accent); color:#fff; min-width:160px; font-size:16px;
      box-shadow:0 8px 24px rgba(224,24,45,.35);
    }
    #shoot[disabled] { opacity:.45; cursor:not-allowed; box-shadow:none; }
    .signature { text-align:center; font-size:12px; color:#fff; margin-top:6px; }
    .flash { position:fixed; inset:0; background:#fff; z-index:9999; }
  </style>
</head>
<body>
  <div class="app">
    <section class="view">
      <video id="v" autoplay playsinline muted></video>
      <div class="overlay"></div>
    </section>

    <section class="ui">
      <div class="status">
        <div class="gate">
          <span class="dot" id="dot"></span>
          <span id="gateText">Waiting for red…</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
          <span class="swatch" title="Target: red"></span>
          <span id="pctText">0.0%</span>
        </div>
      </div>

      <div class="buttons">
        <button id="shoot" disabled>Capture</button>
      </div>

      <div class="signature">made by diego tafuri for digital photography class :)</div>
    </section>
  </div>

  <canvas id="c" hidden></canvas>

  <script>
    const v = document.getElementById('v');
    const c = document.getElementById('c');
    const ctx = c.getContext('2d', { willReadFrequently: true });

    const shoot = document.getElementById('shoot');
    const gateText = document.getElementById('gateText');
    const dot = document.getElementById('dot');
    const pctText = document.getElementById('pctText');

    // Red gating parameters
    const targetHue = 0;      // red at 0° / 360°
    const tolerance = 10;     // stricter tolerance
    const minPct = 35;        // minimum % of frame that must be "red"

    async function start() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: 'environment' },
          audio: false
        });
        v.srcObject = stream;

        // Match canvas size to actual video resolution
        v.addEventListener('loadedmetadata', () => {
          c.width = v.videoWidth;
          c.height = v.videoHeight;
        });

        analyze();
      } catch (e) {
        gateText.textContent = 'Camera permission denied.';
        console.error(e);
      }
    }

    function rgbToHue(r,g,b){
      r/=255; g/=255; b/=255;
      const max = Math.max(r,g,b), min = Math.min(r,g,b);
      const d = max - min;
      let h = 0;
      if (d !== 0){
        if (max === r) h = ((g - b) / d) % 6;
        else if (max === g) h = (b - r) / d + 2;
        else h = (r - g) / d + 4;
        h = Math.round(h * 60);
        if (h < 0) h += 360;
      }
      return h;
    }

    function percentTargetHue(imageData){
      const d = imageData.data;
      let hit = 0, total = d.length / 4;
      for (let i=0; i<d.length; i+=4){
        const h = rgbToHue(d[i], d[i+1], d[i+2]);
        const diff = Math.min(
          Math.abs(h - targetHue),
          Math.abs(h - targetHue + 360),
          Math.abs(h - targetHue - 360)
        );
        if (diff <= tolerance) hit++;
      }
      return (hit / total) * 100;
    }

    function analyze(){
      if (v.readyState >= 2 && c.width && c.height){
        ctx.drawImage(v, 0, 0, c.width, c.height);
        const data = ctx.getImageData(0, 0, c.width, c.height);
        const pct = percentTargetHue(data);
        pctText.textContent = `${pct.toFixed(1)}%`;

        const ok = pct >= minPct;
        shoot.disabled = !ok;
        dot.classList.toggle('ok', ok);
        gateText.textContent = ok ? 'Red dominant — ready' : 'Waiting for red…';
      }
      requestAnimationFrame(analyze);
    }

    function capture(){
      const jpg = c.toDataURL('image/jpeg', 0.95); // save as JPEG
      const a = document.createElement('a');
      a.href = jpg;
      a.download = `red_${Date.now()}.jpg`;
      a.click();
    }

    shoot.addEventListener('click', capture);

    start();
  </script>
</body>
</html>
